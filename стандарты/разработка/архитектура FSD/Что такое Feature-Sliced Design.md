В этом уроке мы рассмотрим основные слои, правила импортов и подходы к минимизации зацепленности. Вы узнаете, как организовать проект, чтобы каждый слой и его компоненты были независимы и легко поддерживались.

# Обзор FSD

Feature-Sliced Design помогает разбить проект на понятные и функциональные слои, где каждый слой выполняет свою задачу.

Между слоями, а также внутри них, есть правила, которые помогают сделать структуру проекта чище, а архитектуру нагляднее.

### Начнем с того, как обычно структурируют frontend-проект

- Базовые компоненты
- Страницы (часто создаваемые фреймворком)
- Утилиты

```tsx
src/
  ├── assets/
  │   ├── images/
  │   └── styles/
  ├── api/
  │   ├── user/
  │   └── blog/
  ├── contexts/
  │   └── ThemeContext.tsx
  ├── constants/
  │   └── index.ts
  ├── components/
  │   ├── Button/
  │   ├── Input/
  │   └── Modal/
  ├── hooks/
  │   └── useAuth.ts
  ├── pages/
  │   ├── Home/
  │   ├── About/
  │   └── Contact/
  ├── services/
  │   ├── UserService/
  │   └── BlogService/
  ├── types/
  │   └── index.ts
  ├── utils/
  │   ├── api.ts
  │   ├── helpers.ts
  │   └── constants.ts
  └── App.tsx
```

Это типичная структура React проекта, где код разделен по техническому признаку. Такой подход прост для понимания на старте, но может стать проблемой при масштабировании

Альтернативой этому часто является разделение на функциональные блоки, хотя обычно внутри каждого блока структура модулей уникальна. Feature-Sliced Design предлагает некоторую унификацию структуры проекта.

### Основные слои в FSD

Обычно приложение состоит из нескольких базовых слоев. Каждый слой можно нарезать на **слайсы**, формируя горизонтальное деление.

```jsx
src/
  ├── layer3/
  │   ├── sliceA/
  │   └── sliceB/
  ├── layer2/
  │   ├── sliceA/
  │   └── sliceC/
  └── layer1/
      ├── sliceA/
      ├── sliceB/
      └── sliceC/
```

В документации можно увидеть множество дополнительных слоев, которые не понадобятся на первых этапах, но мы постепенно разберем каждый из них.

Главная идея за этими слоями - это направление импортов.

```jsx
src/
  ├── app/                    # Инициализация приложения
  │   ├── styles/
  │   └── index.tsx
  ├── pages/                  # Страницы приложения
  │   ├── main/
  │   └── profile/
  ├── widgets/                # Композиционный слой
  │   ├── header/
  │   └── sidebar/
  ├── features/              # Переиспользуемая функциональность
  │   ├── auth-form/
  │   └── theme-switcher/
  ├── entities/              # Бизнес-сущности
  │   ├── user/
  │   └── post/
  └── shared/               # Переиспользуемые модули
      ├── ui/
      ├── lib/
      └── api/
```

### Правила импортов

Слой может импортировать код только из слоев **ниже** его. Например:

- **Pages** могут импортировать из: Widgets, Features, Entities, Shared
- **Widgets** могут импортировать из: Features, Entities, Shared
- **Features** могут импортировать из: Entities, Shared
- **Entities** могут импортировать только из: Shared

Можно сформулировать более точно: слайс не может импортировать другие слайсы из этого же слоя.

### Слой Shared

**Shared** - это фундамент приложения. Все слои выше могут импортировать код из Shared, а изменения в этом слое потенциально могут повлиять на все приложение. Поэтому этот слой нужно описывать максимально качественно, покрывать документацией, тестами и так далее.

Если в проекте нет shared слоя, это не значит, что нет фундамента, или нет кода, на который опирается весь остальной код приложения. Просто этот код сложно выявить, так как он может быть равномерно распределен по всем директориям проекта.

Это может создавать проблему модификации существующего кода, так как будет опасность сломать какой-нибудь рабочий код, в совершенно неожиданном месте. Без покрытия тестами такой баг будет сложно отловить, не всегда есть возможность проводить полное регрессионное тестирование после каждого Pull Request.

### Слой App

**App** - это верхний слой. Технически из этого слоя никакие другие слои импортировать не могут. Другими словами, только этот слой может импортировать в себя все остальное. Это не значит, что это слой должен знать о том, как устроены все остальные слои, иначе это повысит связность кода и увеличит его хрупкость.

App обычно просто настраивает работу приложения, соединяя все слои и логику вместе. Можно сказать, что это слой инициализации, в случае, когда фреймворк уже занял имя `app/` для директории, можно использовать `init/` смысл не особо поменяется.

Обычно в app кладут глобальные стили, инициализацию провайдеров, связку с роутером, стором и прочими необходимыми для работы инструментами, но инициализацию которых нельзя отнести к какой-то одной странице или фиче.

```tsx
import { Router } from '~/shared/routing';
import { LocalizationProvider } from '~/shared/i18n';
import { ThemeProvider } from '~/shared/theme';
import { Pages } from '~/pages';

import './globals.css';

export const Application = () => {
  return (
    <Router>
      <ThemeProvider>
        <LocalizationProvider>
          <Pages />
        </LocalizationProvider>
      </ThemeProvider>
    </Router>
  );
};
```

## Слой Pages

**Pages** - это точки входа в ваше приложение. Обычно одна страница связана с одним URL. Главная концепция страницы в том, что когда вам нужно отредактировать компонент или форму, Вы всегда начинаете с конкретной страницы, где видели этот компонент. Всю логику относящуюся к конкретной странице стоит размещать именно в слайсе слоя Pages.

Типовая структура страницы выглядит так:

```jsx
src/pages/
  ├── home/
  │   ├── index.ts
  │   ├── page.tsx
  │   ├── model.tsx
  │   ├── ui/
  │   │   ├── hero.tsx
  │   │   └── features.tsx
  │   └── lib/
  │       └── slider.ts
  └── profile/
      ├── index.ts
      ├── page.tsx
      ├── model.tsx
      ├── ui/
      │   ├── info.tsx
      │   └── settings.tsx
      └── lib/
          └── username.ts
```

Каждая страница экспортирует только необходимый минимум через index.ts, обычно это компонент страницы и типы. Внутренняя структура страницы скрыта от остального приложения.

##### Рекомендации

- Не стоит выделять код из страницы в другие слои без требования к переиспользуемости.
- Каждая страница содержит в себе весь код для её реализации и лежит в своём слайсе.
- Без использования файлового роутинга, стоит именовать связанные страницы схожим образом.

### Слой Entities

**Entities** описывают бизнес-сущности. Вы можете добавить туда технические сущности, это не запрещено. Методология FSD - это лишь рекомендация, и как инициатор проекта, Вы сами решаете, как структурировать проект.

Типовая структура слоя Entities может выглядеть так:

```jsx
src/entities/
  ├── viewer/
  │   ├── index.ts
  │   ├── models/
  │   ├── lib/
  │   ├── services/
  │   └── ui/
  ├── users/
  ├── posts/
  └── orders/
```

Каждая сущность экспортирует только необходимый публичный API через index.ts, скрывая внутреннюю реализацию от остального приложения. Насколько возможно, стоит минимизировать импорты из одной сущности в другую.

### Рекомендации

- Используйте единственное число для именования сущностей, чтобы избежать путаницы.
- Каждая сущность описывается в своем собственном слайсе.
- Сущности должны быть максимально не связаны друг с другом.

### Слой Features

**Features** - это переиспользуемые кусочки логики или интерфейса. На практике это означает, что первое время в проекте может не быть этого слоя вовсе. Он появится, только когда станет понятно какой код стоит переиспользовать. Это обусловлено затратами на создание обобщенного кода, ведь придется продумать как лучше перенести код из страницы для удобного использования в других ситуациях.

Рассмотрим пример структуры фичи создания заказа:

```jsx
src/features/
  ├── order-make/
  │   ├── index.ts
  │   ├── ui/
  │   │   ├── order-form.tsx
  │   │   └── summary.tsx
  │   ├── models/
  │   │   ├── types.ts
  │   │   └── store.ts
  │   └── tests/
  │       └── order-single.test.ts
  ├── order-cancel/
  ├── product-rate/
  ├── cart-add/
  └── profile-edit/
```

В большинстве случаев, если код в Features относится только к одной сущности, стоит его положить в Entities. Тогда как любую композицию из нескольких сущностей уже класть в Features.

##### Рекомендации

- Не выделяйте код из страниц в Features, пока не встретите хотя бы три повторения одного и того же кода.
- Именуйте слайсы от общего к частному. Например, сначала сущность, потом действие: **posts-create**, вместо _create-posts_.
- Не создавайте импорты между слайсами в Features, чтобы избежать циклов в дальнейшем.

# Лучшие практики

Хорошей практикой является организация кода так, чтобы слои были минимально зависимы друг от друга - один слой должен знать о других как можно меньше.

То же самое, но гораздо строже можно сказать и о слайсах - в рамках одного слоя, слайс не должен знать о существовании другого слайса.

### Часто используемые слои

Хотя может показаться, что в документации описано много слоёв, на практике активно используются в основном эти пять:

- **App** (инициализация, редактируется редко)
- **Pages** (точка входа, связан с роутером)
- **Features**
- **Entities**
- **Shared** (переиспользуемые блоки кода)

Если слой пуст, нет необходимости создавать для него отдельную директорию, поэтому во многих небольших проектах может не быть даже слоя Features.

Для объединения нескольких разных слайсов Features, можно создать слой Widgets. Кроме того, можно создавать свои слои, соблюдая правила импорта, например: **Layouts**, **Compositions**.

# Важные правила

1. **Запрет на кросс-слайсовые импорты**: В пределах одного слоя нельзя импортировать из одного слайса в другой (за исключением виджетов).
2. **Импорт сверху вниз**: Всегда импортируйте код только из нижних слоёв, относительно текущего.
3. **Минимизация зацепленности**: Чем меньше слайсы и слои знают друг о друге, тем проще поддерживать проект.
